# Transmode A: β公開対応 - クオータ/課金システム完成

**開始時刻**: 2026-02-02 20:07:58 JST
**目的**: Plan A（課金ON・本番同構成）でβ公開できる状態にする

---

## Step 0: 作業準備

- Goal: ログファイル作成、現状確認
- Commands:
  ```sh
  mkdir -p logs
  git status --short
  git checkout -b feat/quota-system-beta
  ```
- Observations: ブランチ作成完了
- Decision: 計画に従い順次実装

---

## Step 1: PLANS設定変更 (app.py)

- Goal: Free月次20分、日次ジョブ10回に設定
- Diff summary:
  - `quotaSeconds`: 1800→1200 (30分→20分)
  - `baseMonthlyQuotaSeconds`: 1800→1200
  - `dailyJobLimit`: 10 追加 (free), None (pro)
- Risks: 既存ユーザーの月次制限が減少（β許容）

---

## Step 2: 日次ジョブカウント管理 (app.py)

- Goal: jobCountToday フィールド追加、dayKey リセット時に0にリセット
- Changes:
  - `normalize_user_usage_data()`: dayKey変更時に `jobCountToday=0`
  - `_create_job_core()`: `dailyJobLimit` 判定追加、成功時に `Increment(1)`
- Risks: なし（新規フィールド）

---

## Step 3: エラーレスポンス統一 (app.py)

- Goal: HTTP 429 統一、machine-readable keys
- Changes:
  - `no_remaining_minutes` → `monthly_quota_exhausted` (429)
  - `daily_limit_reached` (429)
  - `daily_job_limit_reached` (429) 新規追加
  - `rate_limited` (429)
  - `no_reservable_minutes` → `monthly_quota_exhausted` (429)
- Risks: クライアント側でエラーコード変更への対応が必要

---

## Step 4: /api/v1/me レスポンス拡張 (app.py)

- Goal: 新規フィールド追加
- New fields:
  - `monthLimitMin`, `monthUsedMin`, `monthRemainingMin`
  - `dayLimitMin`, `dayUsedMin`, `dayRemainingMin`
  - `dayJobLimit`, `dayJobUsed`, `dayJobRemaining`
  - `concurrentLimit`, `concurrentActive`
  - `retentionDays`
  - `billingEnabled`, `purchaseAvailable`
- Risks: なし（既存フィールドは維持）

---

## Step 5: UI更新 (public/app.js)

- Goal: XSS安全なDOM操作、新フィールド対応
- Changes:
  - `blockedReasonMessages`: `daily_job_limit_reached` 追加
  - `updateQuotaInfo()`: ジョブ数表示追加 `ジョブ: 0/10回`
  - `updateQuotaBreakdown()`: innerHTML → createElement + textContent
  - `applyQuotaFromPayload()`: 新フィールド追加
  - `createDefaultQuotaState()`: 新フィールド追加
  - 429エラー処理: quota制限エラーの区別
- Risks: XSS安全性向上

---

## Step 6: 構文チェック

- Commands:
  ```sh
  python -m py_compile app.py
  node --check public/app.js
  ```
- Result: OK

---

## 変更ファイル一覧

```
app.py        | 95 ++++++++++++++++++++++++++++++++++++++++++++++-------------
public/app.js | 80 ++++++++++++++++++++++++++++++++++++++++++-------
static/app.js | (public/app.js から同期)
```

---

## Step 7: コミット

- Commit: `0f9cfb1`
- Branch: `feat/quota-system-beta`
- Message: `feat: implement quota system for beta release (Plan A)`

---

## 動作確認手順

### 1. ローカルテスト
```sh
python -m py_compile app.py
node --check public/app.js
```

### 2. Free ユーザーテスト
1. ログイン → GET /api/v1/me で quota 確認
2. ジョブ作成 → 成功 → dayJobUsed=1
3. 10回目のジョブ作成 → 成功 → dayJobUsed=10
4. 11回目のジョブ作成 → **429 daily_job_limit_reached**
5. 10分使用 → **429 daily_limit_reached**
6. 20分使用 → **429 monthly_quota_exhausted**

### 3. Pro ユーザーテスト
1. ログイン → GET /api/v1/me で dayJobLimit=null 確認
2. ジョブ作成 → 無制限に作成可能

### 4. UI確認
1. ヘッダーのクオータ表示: `本日: 10分 ジョブ: 0/10回 / 今月: 20分`
2. 設定モーダルの詳細表示 (createElement + textContent で構築)
3. 超過時のエラーメッセージ（日本語）

---

## ロールバック手順

```sh
git revert 0f9cfb1
# または
git checkout main
git branch -D feat/quota-system-beta
```

---

## 次のタスク（残り）

1. Stripe Webhook冪等性の確認/強化
2. 購入後の「再同期」ボタン追加
3. 成果物カードの「Codex Prompt」ボタン追加
4. E2Eテスト: Free→Pro→チケット購入→反映
5. デプロイ: `firebase deploy --only hosting` + Cloud Run

---

**完了時刻**: 2026-02-02 20:15 JST

---

## Step 8: formatMinutes 堅牢化パッチ

- Goal: Pro プランでも minutes 表示が崩れないように最小パッチ適用
- Changes:
  1. `formatMinutes` にコメント追加 + `String()` でラップ（戻り値を常に文字列に）
  2. `dayMin` 計算に Pro 分岐追加（Pro では計算スキップ）

### Diff summary
```diff
+// UI表示専用: 常に文字列を返す（数値 or '–'）
 const formatMinutes = (seconds) => {
   if (typeof seconds !== 'number' || Number.isNaN(seconds)) return '–';
-  return Math.max(0, Math.floor(seconds / 60));
+  return String(Math.max(0, Math.floor(seconds / 60)));
 };

-  const dayMin = formatMinutes(q.dailyRemainingSeconds);
+  const dayMin = q.plan === 'free' ? formatMinutes(q.dailyRemainingSeconds) : null;
```

### Verification
```sh
node --check public/app.js  # → OK
```

### Why this fix ensures Pro never breaks
`formatMinutes` が常に文字列を返すことで、テンプレートリテラル内での暗黙の型変換に依存しなくなる。
Pro では `dayMin` の計算自体をスキップするため、null/undefined が渡されるケースが減る。

---
