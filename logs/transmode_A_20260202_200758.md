# Transmode A: β公開対応 - クオータ/課金システム完成

**開始時刻**: 2026-02-02 20:07:58 JST
**目的**: Plan A（課金ON・本番同構成）でβ公開できる状態にする

---

## Step 0: 作業準備

- Goal: ログファイル作成、現状確認
- Commands:
  ```sh
  mkdir -p logs
  git status --short
  git checkout -b feat/quota-system-beta
  ```
- Observations: ブランチ作成完了
- Decision: 計画に従い順次実装

---

## Step 1: PLANS設定変更 (app.py)

- Goal: Free月次20分、日次ジョブ10回に設定
- Diff summary:
  - `quotaSeconds`: 1800→1200 (30分→20分)
  - `baseMonthlyQuotaSeconds`: 1800→1200
  - `dailyJobLimit`: 10 追加 (free), None (pro)
- Risks: 既存ユーザーの月次制限が減少（β許容）

---

## Step 2: 日次ジョブカウント管理 (app.py)

- Goal: jobCountToday フィールド追加、dayKey リセット時に0にリセット
- Changes:
  - `normalize_user_usage_data()`: dayKey変更時に `jobCountToday=0`
  - `_create_job_core()`: `dailyJobLimit` 判定追加、成功時に `Increment(1)`
- Risks: なし（新規フィールド）

---

## Step 3: エラーレスポンス統一 (app.py)

- Goal: HTTP 429 統一、machine-readable keys
- Changes:
  - `no_remaining_minutes` → `monthly_quota_exhausted` (429)
  - `daily_limit_reached` (429)
  - `daily_job_limit_reached` (429) 新規追加
  - `rate_limited` (429)
  - `no_reservable_minutes` → `monthly_quota_exhausted` (429)
- Risks: クライアント側でエラーコード変更への対応が必要

---

## Step 4: /api/v1/me レスポンス拡張 (app.py)

- Goal: 新規フィールド追加
- New fields:
  - `monthLimitMin`, `monthUsedMin`, `monthRemainingMin`
  - `dayLimitMin`, `dayUsedMin`, `dayRemainingMin`
  - `dayJobLimit`, `dayJobUsed`, `dayJobRemaining`
  - `concurrentLimit`, `concurrentActive`
  - `retentionDays`
  - `billingEnabled`, `purchaseAvailable`
- Risks: なし（既存フィールドは維持）

---

## Step 5: UI更新 (public/app.js)

- Goal: XSS安全なDOM操作、新フィールド対応
- Changes:
  - `blockedReasonMessages`: `daily_job_limit_reached` 追加
  - `updateQuotaInfo()`: ジョブ数表示追加 `ジョブ: 0/10回`
  - `updateQuotaBreakdown()`: innerHTML → createElement + textContent
  - `applyQuotaFromPayload()`: 新フィールド追加
  - `createDefaultQuotaState()`: 新フィールド追加
  - 429エラー処理: quota制限エラーの区別
- Risks: XSS安全性向上

---

## Step 6: 構文チェック

- Commands:
  ```sh
  python -m py_compile app.py
  node --check public/app.js
  ```
- Result: OK

---

## 変更ファイル一覧

```
app.py        | 95 ++++++++++++++++++++++++++++++++++++++++++++++-------------
public/app.js | 80 ++++++++++++++++++++++++++++++++++++++++++-------
static/app.js | (public/app.js から同期)
```

---

## Step 7: コミット

- Commit: `0f9cfb1`
- Branch: `feat/quota-system-beta`
- Message: `feat: implement quota system for beta release (Plan A)`

---

## 動作確認手順

### 1. ローカルテスト
```sh
python -m py_compile app.py
node --check public/app.js
```

### 2. Free ユーザーテスト
1. ログイン → GET /api/v1/me で quota 確認
2. ジョブ作成 → 成功 → dayJobUsed=1
3. 10回目のジョブ作成 → 成功 → dayJobUsed=10
4. 11回目のジョブ作成 → **429 daily_job_limit_reached**
5. 10分使用 → **429 daily_limit_reached**
6. 20分使用 → **429 monthly_quota_exhausted**

### 3. Pro ユーザーテスト
1. ログイン → GET /api/v1/me で dayJobLimit=null 確認
2. ジョブ作成 → 無制限に作成可能

### 4. UI確認
1. ヘッダーのクオータ表示: `本日: 10分 ジョブ: 0/10回 / 今月: 20分`
2. 設定モーダルの詳細表示 (createElement + textContent で構築)
3. 超過時のエラーメッセージ（日本語）

---

## ロールバック手順

```sh
git revert 0f9cfb1
# または
git checkout main
git branch -D feat/quota-system-beta
```

---

## 次のタスク（残り）

1. Stripe Webhook冪等性の確認/強化
2. 購入後の「再同期」ボタン追加
3. 成果物カードの「Codex Prompt」ボタン追加
4. E2Eテスト: Free→Pro→チケット購入→反映
5. デプロイ: `firebase deploy --only hosting` + Cloud Run

---

**完了時刻**: 2026-02-02 20:15 JST

---

## Step 8: formatMinutes 堅牢化パッチ

- Goal: Pro プランでも minutes 表示が崩れないように最小パッチ適用
- Changes:
  1. `formatMinutes` にコメント追加 + `String()` でラップ（戻り値を常に文字列に）
  2. `dayMin` 計算に Pro 分岐追加（Pro では計算スキップ）

### Diff summary
```diff
+// UI表示専用: 常に文字列を返す（数値 or '–'）
 const formatMinutes = (seconds) => {
   if (typeof seconds !== 'number' || Number.isNaN(seconds)) return '–';
-  return Math.max(0, Math.floor(seconds / 60));
+  return String(Math.max(0, Math.floor(seconds / 60)));
 };

-  const dayMin = formatMinutes(q.dailyRemainingSeconds);
+  const dayMin = q.plan === 'free' ? formatMinutes(q.dailyRemainingSeconds) : null;
```

### Verification
```sh
node --check public/app.js  # → OK
```

### Why this fix ensures Pro never breaks
`formatMinutes` が常に文字列を返すことで、テンプレートリテラル内での暗黙の型変換に依存しなくなる。
Pro では `dayMin` の計算自体をスキップするため、null/undefined が渡されるケースが減る。

---
## Step 1: ブランチをpush

- Command: `git status --short`
- Result:
  - M ops/logs/smokecheck.err
  - M ops/logs/smokecheck.out
  - M ops/logs/smokecheck.rotated_date
  - ?? .mcp.json
- Decision: 作業ツリーは汚れているが、今回の検証/デプロイには影響しないため継続。

- Command: `git log -1 --oneline`
- Result: `a4e03bf fix: harden formatMinutes for pro quota display`
- Decision: 最終コミットは想定どおり。pushを継続。

- Command: `git push -u origin feat/quota-system-beta`
- Result: リモートに新規ブランチ作成は成功。ただし `.git/config` ロック失敗により upstream 設定は未完了。
- Decision: push 自体は成功したため手順継続（必要なら後で `git branch --set-upstream-to=origin/feat/quota-system-beta` を実施）。

## Step 2: E2E（最小）

- Command: `gcloud --project realtime-translator-pwa-483710 run services describe realtime-translator-api --region asia-northeast1 --format='value(status.url)'`
- Result: `https://realtime-translator-api-7xgx6ra47q-an.a.run.app`
- Decision: APP_BASE_URL を上記 Cloud Run URL に設定して続行。

- Command: `gcloud ... run services describe ...` (初回)
- Result: gcloud 設定ディレクトリに書き込めず `credentials.db` 作成失敗。
- Decision: サンドボックス外実行許可を取得して再実行。

- Command: `printenv`（Firebase必須envの有無確認）
- Result: FIREBASE_WEB_API_KEY=set / FIREBASE_EMAIL=unset / FIREBASE_PASSWORD=unset
- Decision: `scripts/get_firebase_id_token.sh` を使うには EMAIL/PASSWORD が必要。ユーザーに提供を依頼。

---

## Step E2E-1: Free ユーザー E2E 検証

- Goal: Free プランのクオータ制限（日次ジョブ10回上限）が期待どおり動作することを確認
- Date: 2026-02-03 19:20 JST

### Step 0: 前提チェック
- Command: `export ID_TOKEN` / トークン形式確認
- Result: len=1208, dot_count=2, starts_with=eyJ, APP_BASE_URL=設定済み
- Decision: OK

### Step 1: health
- Command: `GET /health`
- Result: HTTP=200, `{"ok":true, "service":"realtime-translator-api", "version":"local"}`
- Decision: OK

### Step 2: /api/v1/me
- Command: `GET /api/v1/me` (Bearer認証)
- Result: HTTP=200

  | フィールド | 期待値 | 実際値 | 判定 |
  |-----------|--------|--------|------|
  | plan | free | free | OK |
  | monthLimitMin | 20 | 20 | OK |
  | dayLimitMin | 10 | 10 | OK |
  | dayJobLimit | 10 | 10 | OK |
  | retentionDays | 7 | 7 | OK |
  | dayJobUsed | 0 | 0 | OK |
  | dayJobRemaining | 10 | 10 | OK |

- Decision: 全期待値一致。OK

### Step 3: jobs loop (11回)
- Command: `/tmp/e2e_jobs.sh` 実行（create→complete×10回、11回目createのみ）
- sleep: 12秒/回（createRateLimit 6/min 回避）
- Result:

  | TRY | create HTTP | complete HTTP | 備考 |
  |-----|-----------|--------------|------|
  | 1 | 200 | 200 | jobId取得・complete成功 |
  | 2 | 200 | 200 | |
  | 3 | 200 | 200 | |
  | 4 | 200 | 200 | |
  | 5 | 200 | 200 | |
  | 6 | 200 | 200 | billedSeconds=1（audioSeconds=1が反映） |
  | 7 | 200 | 200 | reservedSeconds=599（1秒消費済み） |
  | 8 | 200 | 200 | |
  | 9 | 200 | 200 | |
  | 10 | 200 | 200 | |
  | **11** | **429** | — | **detail=daily_job_limit_reached** |

- Decision: 期待どおり。11回目で HTTP 429 + `daily_job_limit_reached` を確認。

### 総合判定: PASS

- `/api/v1/me` の Free プラン制限値: 全項目一致
- 日次ジョブ上限 (dayJobLimit=10): 10回成功、11回目で正しく 429 拒否
- エラーコード: `daily_job_limit_reached` （期待通り）

**検証完了時刻**: 2026-02-03 19:24 JST

---

## Step 9: 再同期ボタン追加 (feat: resync quota)

- Goal: billingSection に「再同期」ボタンを追加し、ユーザーが手動で /api/v1/me を再取得して UI を最新化できるようにする
- Date: 2026-02-03 JST

### 変更内容

| ファイル | 変更 |
|---------|------|
| `public/index.html` | `#buyTicketBtn` の後に `<button id="resyncQuotaBtn">` 追加 |
| `public/app.js` | i18n (ja/en/zh) 3キー追加、`els.resyncQuotaBtn` 追加、`resyncQuota()` 関数追加、`updateBillingSection` に表示制御追加、`showBillingBanner` に error ケース追加、イベント登録追加 |
| `static/app.js` | public/app.js から同期 |

### Diff要点

- `resyncQuota()`: `authFetch('/api/v1/me', { cache: 'no-store' })` → `applyQuotaFromPayload(data)` → `showBillingBanner('success')`
- ボタンラベル復元は `t('resyncQuota')` を使用（locale変更に対応、origLabel不使用）
- XSS安全: innerHTML未使用、createElement + textContent のみ

### 検証

- Command: `node --check public/app.js`
- Result: OK（構文エラーなし）
- Decision: コミット実施
